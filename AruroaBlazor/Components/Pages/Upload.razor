@page "/upload"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h3>Upload Song</h3>

@if (user == null)
{
    <p>You must be logged in to upload a song.</p>
}
else
{
    <input placeholder="Song Title" @bind="title" />
    <br />
    <InputFile OnChange="OnFileSelected" accept="audio/*" />
    <br />
    <button @onclick="UploadSong">Upload</button>
    <p>@message</p>
}

@code {
    User user;
    IBrowserFile selectedFile;
    string title;
    string message;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            user = result.Value;
            StateHasChanged();
        }
    }

    void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
    }

    async Task UploadSong()
    {
        if (string.IsNullOrWhiteSpace(title))
        {
            message = "Please enter a song title.";
            return;
        }

        if (selectedFile == null)
        {
            message = "Please select an audio file.";
            return;
        }

        using var stream = selectedFile.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        byte[] audioData = ms.ToArray();

        // Create Song object
        Song song = new Song
        {
            title = title,
            audioData = audioData,
            userid = user.userid,
            uploaded = DateTime.Now
        };

        // Insert using public method
        SongDB songDB = new SongDB();
        await songDB.AddSongAsync(song);

        message = "Song uploaded successfully!";
        title = "";
        selectedFile = null;
    }

}
