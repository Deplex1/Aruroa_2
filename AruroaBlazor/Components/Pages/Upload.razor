@page "/upload"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Forms; 
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage 

<h3>Upload Song</h3>

<input type="text" placeholder="Title" @bind="title" />
<br />

<input type="number" placeholder="Genre ID" @bind="genreID" />
<br />


<InputFile OnChange="OnFileSelected" />



<br />

<button @onclick="UploadSong">Upload</button>

<p>@message</p>

@code
{

    User user = null;
    string title = "";
    int genreID = 1;
    byte[] fileData = null;
    int duration = 0;
    string message = "";


        protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await Storage.GetAsync<User>("user");

        if (!result.Success)
        {
            Nav.NavigateTo("/login");
        }

        user = result.Value;
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        try
        {
            // 10 MB limit for 2026 standards
            long maxFileSize = 10 * 1024 * 1024;

            // Open the stream from the browser file
            using var stream = e.File.OpenReadStream(maxFileSize);
            
            // Use a MemoryStream to hold the incoming bytes
            using var ms = new MemoryStream();

            // Copy the data from the browser stream to memory
            await stream.CopyToAsync(ms);

            // put the memory inside the fileData property
            fileData = ms.ToArray();

            message = $"File '{e.File.Name}' uploaded successfully.";

        }
        catch (System.IO.IOException ex)
        {
            // Handle file size or IO issues specifically
            Console.WriteLine($"File error: {ex.Message}");
        }
        catch (Exception ex)
        {
            // Handle all other unexpected errors
            Console.WriteLine($"Upload failed: {ex.Message}");
        }
    }
    

    async Task UploadSong()
    {
        if(fileData != null)
        {
            Song s = new Song();
            s.title = title;
            s.duration = duration;
            s.audioData = fileData;
            s.userid = user.userid;
            s.genreID = genreID;

            SongDB db = new SongDB();
            await db.InsertSongAsync(s);

            message = "Song uploaded successfully";
        }
        else
            message = "No song found, Have you uploaded a song?";
    }
}
