@page "/profile"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h1>Profile</h1>

@if (user == null)
{
    <p>You are not logged in</p>
}
else
{
    <div class="profile-container">
        <div class="profile-header">
            <label class="avatar-wrapper">
                @if (user.profilepicture != null)
                {
                    <img src="@GetProfileImage(user.profilepicture)" class="avatar-img" />
                }
                else
                {
                    <span class="avatar-placeholder">+</span>
                }
                <InputFile OnChange="OnProfileImageSelected" accept="image/*" style="display:none" />
            </label>
            <h3>@user.username</h3>
        </div>

        <div class="profile-info">
            <p><strong>Email:</strong> @user.email</p>
            <p><strong>Admin:</strong> @(user?.IsAdmin == 1 ? "Yes" : "No")</p>
        </div>

        <div class="profile-section">
            <h2>Uploaded Songs</h2>
            @if (UserSongs == null || UserSongs.Count == 0)
            {
                <p>No songs uploaded</p>
            }
            else
            {
                @foreach (Song song in UserSongs)
                {
                    <div class="song-card">
                        <h4>@song.title</h4>
                        @{
                            var audioSource = song.GetAudioSource(song.audioData);
                        }
                        @if (!string.IsNullOrEmpty(audioSource))
                        {
                            <div class="audio-container">
                                <audio controls preload="none">
                                    <source src="@audioSource" />
                                    Your browser does not support the audio element.
                                </audio>
                            </div>
                        }
                        else
                        {
                            <p class="no-audio">No audio data available</p>
                        }
                    </div>
                }
            }
        </div>

        <div class="profile-section">
            <h2>Playlists</h2>
            @if (UserPlaylists == null || UserPlaylists.Count == 0)
            {
                <p>No playlists created</p>
            }
            else
            {
                @foreach (Playlist playlist in UserPlaylists)
                {
                    <div class="playlist-card">
                        <h4><a href="/playlist/@playlist.playlistid">@playlist.name</a></h4>
                        <p>Status: @(playlist.ispublic ? "Public" : "Private")</p>
                    </div>
                }
            }
        </div>

        <div class="profile-actions">
            <button @onclick="GoUpload" class="btn">Upload Song</button>
            <button @onclick="Logout" class="btn btn-secondary">Logout</button>
        </div>
    </div>
}

@code {
    private User? user;
    private List<Song> UserSongs = new List<Song>();
    private List<Playlist> UserPlaylists = new List<Playlist>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await Storage.GetAsync<User>("user");
        if (result.Success && result.Value != null)
        {
            user = result.Value;
            await LoadUserData();
            StateHasChanged();
        }
        else
        {
            user = null;
            UserSongs = new List<Song>();
            UserPlaylists = new List<Playlist>();
            StateHasChanged();
        }
    }

    private async Task LoadUserData()
    {
        if (user == null) return;
        
        try
        {
            DBL.SongDB songDB = new DBL.SongDB();
            UserSongs = await songDB.SelectSongsByUserIDAsync(user.userid);

            DBL.PlaylistDB playlistDB = new DBL.PlaylistDB();
            UserPlaylists = await playlistDB.GetUserPlaylistsAsync(user.userid);
        }
        catch (Exception ex)
        {
            // Handle error silently or log it
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    private async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login", true);
    }

    private async Task OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null || user == null) return;

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            byte[] imageBytes = ms.ToArray();
            user.profilepicture = imageBytes;

            DBL.UserDB userDB = new DBL.UserDB();
            await userDB.UpdateUserAsync(user.userid, new Dictionary<string, object> { { "profilepicture", imageBytes } });
            
            // Update storage with the new user data
            await Storage.SetAsync("user", user);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading profile image: {ex.Message}");
        }
    }

    private string? GetProfileImage(byte[]? imageData)
    {
        if (imageData == null || imageData.Length == 0) return null;
        return $"data:image/png;base64,{Convert.ToBase64String(imageData)}";
    }
}
