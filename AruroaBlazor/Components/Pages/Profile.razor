@page "/profile"
@page "/profile/{ViewUserId:int}"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Services
@using DBL
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h1>Profile</h1>

@if (user == null)
{
    <p>You are not logged in</p>
}
else
{
    <div class="profile-container">

        <div class="profile-header">
            @if (isViewingOwnProfile)
            {
                <label class="avatar-wrapper">

                    @if (user.profilepicture != null)
                    {
                        <img src="@GetProfileImage(user.profilepicture)" class="avatar-img" />
                    }
                    else
                    {
                        <span class="avatar-placeholder">+</span>
                    }

                    <InputFile OnChange="OnProfileImageSelected"
                               accept="image/*"
                               style="display:none" />
                </label>
            }
            else
            {
                <div class="avatar-wrapper-readonly">
                    @if (viewedUser != null && viewedUser.profilepicture != null)
                    {
                        <img src="@GetProfileImage(viewedUser.profilepicture)" class="avatar-img" />
                    }
                    else
                    {
                        <span class="avatar-placeholder">?</span>
                    }
                </div>
            }

            @if (isViewingOwnProfile)
            {
                <h3>@user.username</h3>
            }
            else if (viewedUser != null)
            {
                <h3>@viewedUser.username</h3>
            }
        </div>

        <!-- User Stats Section (visible to everyone) -->
        <div class="user-stats">
            <div class="stat">
                <span class="stat-number">@totalSongs</span>
                <span class="stat-label">Songs</span>
            </div>
            <div class="stat">
                <span class="stat-number">@totalPlays</span>
                <span class="stat-label">Total Plays</span>
            </div>
        </div>

        @if (isViewingOwnProfile)
        {
            <div class="profile-info">
                <p><strong>Email:</strong> @user.email</p>

                <p>
                    <strong>Admin:</strong>
                    @if (user.IsAdmin == 1)
                    {
                        <span>Yes</span>
                    }
                    else
                    {
                        <span>No</span>
                    }
                </p>
            </div>
        }

        <div class="profile-section">
            <h2>Uploaded Songs</h2>

            @if (UserSongs == null || UserSongs.Count == 0)
            {
                <p>No songs uploaded</p>
            }
            else
            {
                @foreach (Song song in UserSongs)
                {
                    <div class="song-card">
                        <h4>@song.title</h4>

                        @{
                            string audioSource = song.GetAudioSource(song.audioData);
                        }

                        @if (!string.IsNullOrEmpty(audioSource))
                        {
                            <audio controls preload="none">
                                <source src="@audioSource" />
                            </audio>
                        }
                        else
                        {
                            <p>No audio data available</p>
                        }

                        @if (isViewingOwnProfile)
                        {
                            <button @onclick="() => DeleteSong(song.songID)">
                                Delete
                            </button>
                        }
                    </div>
                }
            }
        </div>

        <div class="profile-section">
            <h2>Playlists</h2>

            @if (UserPlaylists == null || UserPlaylists.Count == 0)
            {
                @if (isViewingOwnProfile)
                {
                    <p>No playlists created</p>
                }
                else
                {
                    <p>No public playlists</p>
                }
            }
            else
            {
                @foreach (Playlist playlist in UserPlaylists)
                {
                    <div class="playlist-card">
                        <h4>
                            <a href="/playlist/@playlist.playlistid">
                                @playlist.name
                            </a>
                        </h4>

                        @if (isViewingOwnProfile)
                        {
                            <p>
                                Status:
                                @if (playlist.ispublic)
                                {
                                    <span>Public</span>
                                }
                                else
                                {
                                    <span>Private</span>
                                }
                            </p>
                        }
                    </div>
                }
            }
        </div>

        @if (isViewingOwnProfile)
        {
            <div class="profile-actions">
                <button @onclick="GoUpload">Upload Song</button>
                <button @onclick="ViewPublicProfile">View Public Profile</button>
                <button @onclick="Logout">Logout</button>
            </div>
        }
        else
        {
            <div class="profile-actions">
                <button @onclick="GoBack">Back</button>
            </div>
        }

    </div>
}

@code {
    // Service instance
    private ProfileService profileService = new ProfileService();

    // Route parameter
    [Parameter]
    public int ViewUserId { get; set; }

    // UI state variables
    private User? user;
    private User? viewedUser;
    private List<Song> UserSongs = new List<Song>();
    private List<Playlist> UserPlaylists = new List<Playlist>();
    private bool isViewingOwnProfile = false;
    private int totalSongs = 0;
    private int totalPlays = 0;

    // Lifecycle method - loads data on first render
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == false)
        {
            return;
        }

        var result = await Storage.GetAsync<User>("user");

        if (result.Success && result.Value != null)
        {
            user = result.Value;

            // Check if viewing own profile or someone else's
            if (ViewUserId == 0 || ViewUserId == user.userid)
            {
                isViewingOwnProfile = true;
                viewedUser = user;
                await LoadOwnProfile();
            }
            else
            {
                isViewingOwnProfile = false;
                await LoadPublicProfile(ViewUserId);
            }
        }
        else
        {
            user = null;
            UserSongs.Clear();
            UserPlaylists.Clear();
        }

        StateHasChanged();
    }

    // Load own profile (full access including private playlists)
    private async Task LoadOwnProfile()
    {
        if (user == null)
        {
            return;
        }

        UserSongs = await profileService.LoadUserSongsAsync(user.userid);
        UserPlaylists = await profileService.LoadUserPlaylistsAsync(user.userid);

        // Load stats
        var stats = await profileService.GetUserPublicStatsAsync(user.userid);
        totalSongs = stats.totalSongs;
        totalPlays = stats.totalPlays;
    }

    // Load public profile (only public playlists)
    private async Task LoadPublicProfile(int userId)
    {
        // Load viewed user info
        UserDB userDB = new UserDB();
        viewedUser = await userDB.SelectByIdAsync(userId);

        if (viewedUser == null)
        {
            return;
        }

        // Load public data only
        UserSongs = await profileService.LoadUserSongsAsync(userId);
        UserPlaylists = await profileService.LoadPublicPlaylistsAsync(userId);

        // Load stats
        var stats = await profileService.GetUserPublicStatsAsync(userId);
        totalSongs = stats.totalSongs;
        totalPlays = stats.totalPlays;
    }

    // Delete a song using service
    private async Task DeleteSong(int songId)
    {
        if (user == null)
        {
            return;
        }

        if (isViewingOwnProfile == false)
        {
            return;
        }

        bool success = await profileService.DeleteSongAsync(songId);

        if (success)
        {
            // Remove from local list using service
            profileService.RemoveSongFromList(songId, UserSongs);

            // Reload stats
            var stats = await profileService.GetUserPublicStatsAsync(user.userid);
            totalSongs = stats.totalSongs;
            totalPlays = stats.totalPlays;

            StateHasChanged();
        }
    }

    // Navigate to upload page
    private void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    // View public profile
    private void ViewPublicProfile()
    {
        if (user == null)
        {
            return;
        }

        Nav.NavigateTo("/profile/" + user.userid.ToString());
    }

    // Go back to previous page
    private void GoBack()
    {
        Nav.NavigateTo("/songs");
    }

    // Logout user
    private async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login", true);
    }

    // Handle profile image selection using service
    private async Task OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        if (user == null)
        {
            return;
        }

        if (isViewingOwnProfile == false)
        {
            return;
        }

        var file = e.File;
        if (file == null)
        {
            return;
        }

        // Process image using service
        byte[] imageBytes = await profileService.ProcessProfileImageAsync(file);
        if (imageBytes == null)
        {
            return;
        }

        user.profilepicture = imageBytes;

        // Update profile picture using service
        bool success = await profileService.UpdateProfilePictureAsync(user.userid, imageBytes);

        if (success)
        {
            await Storage.SetAsync("user", user);
            StateHasChanged();
        }
    }

    // Get profile image data URL using service
    private string? GetProfileImage(byte[]? imageData)
    {
        return profileService.GetProfileImageDataUrl(imageData);
    }
}
