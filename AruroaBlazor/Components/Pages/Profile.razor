@page "/profile"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<link href="css/site.css" rel="stylesheet" />
<link href="css/profile.css" rel="stylesheet" />

<div class="page-container">

    @if (user == null)
    {
        <p>You are not logged in</p>
    }
    else
    {
        <div class="profile-container">

            <div class="profile-header">
                <label class="avatar-wrapper">
                    @if (user.profilepicture != null)
                    {
                        <img src="@GetProfileImage(user.profilepicture)" class="avatar-img" />
                    }
                    else
                    {
                        <span class="avatar-placeholder">+</span>
                    }
                    <InputFile OnChange="OnProfileImageSelected" accept="image/*" style="display:none" />
                </label>

                <strong>@user.username</strong>
            </div>

            <div class="profile-info">
                <p>Email: @user.email</p>
                <p>Admin: @user.IsAdmin</p>
            </div>

            <div class="profile-songs">
                <h4>Uploaded Songs</h4>
                @if (UserSongs.Count == 0)
                {
                    <p>No songs uploaded</p>
                }
                else
                {
                    @foreach (Song songs in UserSongs)
                    {
                        <div class="profile-song">
                            <p>@songs.title</p>
                            <audio controls src="@songs.GetAudioSource(songs.audioData)"></audio>
                        </div>
                    }
                }
            </div>
            <div class="profile-playlists">
                <h4>Playlists</h4>

                @if (UserPlaylists.Count == 0)
                {
                    <p>No playlists created</p>
                }
                else
                {
                    @foreach (Playlist p in UserPlaylists)
                    {
                        <div class="playlist-item">
                            <a href="/playlist/@p.playlistid">@p.name</a>

                            <span>
                                @(p.ispublic ? "Public" : "Private")
                            </span>
                        </div>
                    }
                }
            </div>

            <div class="profile-actions">
                <button @onclick="GoUpload">Upload Song</button>
                <button @onclick="Logout">Logout</button>
            </div>

        </div>
    }
</div>

@code {
    User user;
    List<Song> UserSongs = new List<Song>();
    List<Playlist> UserPlaylists = new List<Playlist>();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            user = result.Value;
            await LoadUserSongs();
            StateHasChanged();
        }
    }

    async Task LoadUserSongs()
    {
        DBL.SongDB songDB = new DBL.SongDB();
        UserSongs = await songDB.SelectSongsByUserIDAsync(user.userid);

        DBL.PlaylistDB playlistDB = new DBL.PlaylistDB();
        UserPlaylists = await playlistDB.GetUserPlaylistsAsync(user.userid);

    }

    void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login");
    }

    async Task OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        byte[] imageBytes = ms.ToArray();
        user.profilepicture = imageBytes;

        DBL.UserDB userDB = new DBL.UserDB();
        await userDB.UpdateUserAsync(user.userid, new Dictionary<string, object> { { "profilepicture", imageBytes } });
        StateHasChanged();
    }

    string GetProfileImage(byte[] imageData)
    {
        if (imageData == null || imageData.Length == 0) return null;
        return $"data:image/png;base64,{Convert.ToBase64String(imageData)}";
    }
}
