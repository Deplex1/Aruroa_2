@page "/profile"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Services
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h1>Profile</h1>

@if (user == null)
{
    <p>You are not logged in</p>
}
else
{
    <div class="profile-container">

        <div class="profile-header">
            <label class="avatar-wrapper">

                @if (user.profilepicture != null)
                {
                    <img src="@GetProfileImage(user.profilepicture)" class="avatar-img" />
                }
                else
                {
                    <span class="avatar-placeholder">+</span>
                }

                <InputFile OnChange="OnProfileImageSelected"
                           accept="image/*"
                           style="display:none" />
            </label>

            <h3>@user.username</h3>
        </div>

        <div class="profile-info">
            <p><strong>Email:</strong> @user.email</p>

            <p>
                <strong>Admin:</strong>
                @if (user.IsAdmin == 1)
                {
                    <span>Yes</span>
                }
                else
                {
                    <span>No</span>
                }
            </p>
        </div>

        <div class="profile-section">
            <h2>Uploaded Songs</h2>

            @if (UserSongs == null || UserSongs.Count == 0)
            {
                <p>No songs uploaded</p>
            }
            else
            {
                @foreach (Song song in UserSongs)
                {
                    <div class="song-card">
                        <h4>@song.title</h4>

                        @{
                            string audioSource = song.GetAudioSource(song.audioData);
                        }

                        @if (!string.IsNullOrEmpty(audioSource))
                        {
                            <audio controls preload="none">
                                <source src="@audioSource" />
                            </audio>
                        }
                        else
                        {
                            <p>No audio data available</p>
                        }

                        <button @onclick="() => DeleteSong(song.songID)">
                            Delete
                        </button>
                    </div>
                }
            }
        </div>

        <div class="profile-section">
            <h2>Playlists</h2>

            @if (UserPlaylists == null || UserPlaylists.Count == 0)
            {
                <p>No playlists created</p>
            }
            else
            {
                @foreach (Playlist playlist in UserPlaylists)
                {
                    <div class="playlist-card">
                        <h4>
                            <a href="/playlist/@playlist.playlistid">
                                @playlist.name
                            </a>
                        </h4>

                        <p>
                            Status:
                            @if (playlist.ispublic)
                            {
                                <span>Public</span>
                            }
                            else
                            {
                                <span>Private</span>
                            }
                        </p>
                    </div>
                }
            }
        </div>

        <div class="profile-actions">
            <button @onclick="GoUpload">Upload Song</button>
            <button @onclick="Logout">Logout</button>
        </div>

    </div>
}

@code {
    // Service instance
    private ProfileService profileService = new ProfileService();

    // UI state variables
    private User? user;
    private List<Song> UserSongs = new List<Song>();
    private List<Playlist> UserPlaylists = new List<Playlist>();

    // Lifecycle method - loads data on first render
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await Storage.GetAsync<User>("user");

        if (result.Success && result.Value != null)
        {
            user = result.Value;
            await LoadUserData();
        }
        else
        {
            user = null;
            UserSongs.Clear();
            UserPlaylists.Clear();
        }

        StateHasChanged();
    }

    // Load user data using service
    private async Task LoadUserData()
    {
        if (user == null)
        {
            return;
        }

        UserSongs = await profileService.LoadUserSongsAsync(user.userid);
        UserPlaylists = await profileService.LoadUserPlaylistsAsync(user.userid);
    }

    // Delete a song using service
    private async Task DeleteSong(int songId)
    {
        if (user == null)
        {
            return;
        }

        bool success = await profileService.DeleteSongAsync(songId);

        if (success)
        {
            // Remove from local list using service
            profileService.RemoveSongFromList(songId, UserSongs);
            StateHasChanged();
        }
    }

    // Navigate to upload page
    private void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    // Logout user
    private async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login", true);
    }

    // Handle profile image selection using service
    private async Task OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        if (user == null)
        {
            return;
        }

        var file = e.File;
        if (file == null)
        {
            return;
        }

        // Process image using service
        byte[] imageBytes = await profileService.ProcessProfileImageAsync(file);
        if (imageBytes == null)
        {
            return;
        }

        user.profilepicture = imageBytes;

        // Update profile picture using service
        bool success = await profileService.UpdateProfilePictureAsync(user.userid, imageBytes);

        if (success)
        {
            await Storage.SetAsync("user", user);
            StateHasChanged();
        }
    }

    // Get profile image data URL using service
    private string? GetProfileImage(byte[]? imageData)
    {
        return profileService.GetProfileImageDataUrl(imageData);
    }
}
