@page "/profile"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage


<style>
    .profile-pic {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid cyan;
        margin-bottom: 15px;
    }
</style>
<h3>Profile</h3>

@if (user == null)
{
    <p>You are not logged in</p>
}
else
{

    <p>Username: @user.username</p>
    <p>Email: @user.email</p>
    <p>Admin: @user.IsAdmin</p>

    @if (user.profilepicture != null)
    {
        <img src="@GetProfileImage(user.profilepicture)"
             class="profile-pic" />
    }
    else
    {
        <p>No profile picture</p>
    }



    @if (UserSongs.Count == 0)
    {
        <p>No songs uploaded</p>
    }


    else
    {
        <h1> Uploaded Songs: </h1>
        @foreach (Song songs in UserSongs)
        {
            <p> @songs.title </p>
            <audio controls src="@songs.GetAudioSource(songs.audioData)"></audio>

        }

    }
    <button @onclick="Logout">Logout</button>
}

@code
{
    User user;
    List<Song> UserSongs = new List<Song>();

    protected override async Task OnAfterRenderAsync(bool firstbool)
    {
        if (!firstbool)
            return;

        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            user = result.Value;
            StateHasChanged();
            DBL.SongDB songDB = new DBL.SongDB();
            UserSongs = await songDB.SelectSongsByUserIDAsync(user.userid);
        }
    }

    async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login");
    }


    string GetProfileImage(byte[] imageData)
    {
        if (imageData == null || imageData.Length == 0)
            return null;

        string base64 = Convert.ToBase64String(imageData);
        return $"data:image/png;base64,{base64}";
    }
}
