@page "/profile"
@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h1>Profile</h1>

@if (user == null)
{
    <p>You are not logged in</p>
}
else
{
    <div class="profile-container">

        <div class="profile-header">
            <label class="avatar-wrapper">

                @if (user.profilepicture != null)
                {
                    <img src="@GetProfileImage(user.profilepicture)" class="avatar-img" />
                }
                else
                {
                    <span class="avatar-placeholder">+</span>
                }

                <InputFile OnChange="OnProfileImageSelected"
                           accept="image/*"
                           style="display:none" />
            </label>

            <h3>@user.username</h3>
        </div>

        <div class="profile-info">
            <p><strong>Email:</strong> @user.email</p>

            <p>
                <strong>Admin:</strong>
                @if (user.IsAdmin == 1)
                {
                    <span>Yes</span>
                }
                else
                {
                    <span>No</span>
                }
            </p>
        </div>

        <div class="profile-section">
            <h2>Uploaded Songs</h2>

            @if (UserSongs == null || UserSongs.Count == 0)
            {
                <p>No songs uploaded</p>
            }
            else
            {
                @foreach (Song song in UserSongs)
                {
                    <div class="song-card">
                        <h4>@song.title</h4>

                        @{
                            string audioSource = song.GetAudioSource(song.audioData);
                        }

                        @if (!string.IsNullOrEmpty(audioSource))
                        {
                            <audio controls preload="none">
                                <source src="@audioSource" />
                            </audio>
                        }
                        else
                        {
                            <p>No audio data available</p>
                        }

                        <button @onclick="() => DeleteSong(song.songID)">
                            Delete
                        </button>
                    </div>
                }
            }
        </div>

        <div class="profile-section">
            <h2>Playlists</h2>

            @if (UserPlaylists == null || UserPlaylists.Count == 0)
            {
                <p>No playlists created</p>
            }
            else
            {
                @foreach (Playlist playlist in UserPlaylists)
                {
                    <div class="playlist-card">
                        <h4>
                            <a href="/playlist/@playlist.playlistid">
                                @playlist.name
                            </a>
                        </h4>

                        <p>
                            Status:
                            @if (playlist.ispublic)
                            {
                                <span>Public</span>
                            }
                            else
                            {
                                <span>Private</span>
                            }
                        </p>
                    </div>
                }
            }
        </div>

        <div class="profile-actions">
            <button @onclick="GoUpload">Upload Song</button>
            <button @onclick="Logout">Logout</button>
        </div>

    </div>
}

@code {
    private User? user;
    private List<Song> UserSongs = new List<Song>();
    private List<Playlist> UserPlaylists = new List<Playlist>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        var result = await Storage.GetAsync<User>("user");

        if (result.Success && result.Value != null)
        {
            user = result.Value;
            await LoadUserData();
        }
        else
        {
            user = null;
            UserSongs.Clear();
            UserPlaylists.Clear();
        }

        StateHasChanged();
    }

    private async Task LoadUserData()
    {
        if (user == null)
        {
            return;
        }

        SongDB songDB = new SongDB();
        List<Song> songs = await songDB.SelectSongsByUserIDAsync(user.userid);

        if (songs != null)
        {
            UserSongs = songs;
        }
        else
        {
            UserSongs = new List<Song>();
        }

        PlaylistDB playlistDB = new PlaylistDB();
        UserPlaylists = await playlistDB.GetUserPlaylistsAsync(user.userid);
    }

    private async Task DeleteSong(int songId)
    {
        if (user == null)
        {
            return;
        }

        SongDB songDB = new SongDB();
        await songDB.DeleteSongAsync(songId);

        for (int i = 0; i < UserSongs.Count; i++)
        {
            if (UserSongs[i].songID == songId)
            {
                UserSongs.RemoveAt(i);
                break;
            }
        }

        StateHasChanged();
    }


    private void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    private async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login", true);
    }

    private async Task OnProfileImageSelected(InputFileChangeEventArgs e)
    {
        if (user == null)
        {
            return;
        }

        var file = e.File;
        if (file == null)
        {
            return;
        }

        using var stream = file.OpenReadStream(5 * 1024 * 1024);
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        byte[] imageBytes = ms.ToArray();
        user.profilepicture = imageBytes;

        UserDB userDB = new UserDB();
        await userDB.UpdateUserAsync(
            user.userid,
            new Dictionary<string, object>
            {
                { "profilepicture", imageBytes }
            }
        );

        await Storage.SetAsync("user", user);
        StateHasChanged();
    }

    private string? GetProfileImage(byte[]? imageData)
    {
        if (imageData == null || imageData.Length == 0)
        {
            return null;
        }

        return "data:image/png;base64," + Convert.ToBase64String(imageData);
    }
}
