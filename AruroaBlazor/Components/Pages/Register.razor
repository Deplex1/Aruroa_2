@page "/register"
@using DBL
@using Models
@inject NavigationManager Nav

<h3>Register</h3>

<input placeholder="Username" @bind="username" />
<br />
<input placeholder="Email" @bind="email" />
<br />
<input placeholder="Password" type="password" @bind="password" />
<br />
<button @onclick="RegisterMethod">Register</button>

<p>@message</p>

@code {
    string username;
    string email;
    string password;
    string message;
    UserDB userDB = new UserDB();

    async Task RegisterMethod()
    {
        if (string.IsNullOrWhiteSpace(username) ||
            string.IsNullOrWhiteSpace(password) ||
            string.IsNullOrWhiteSpace(email))
        {
            message = "All fields are required";
            return;
        }

        if (!IsValidEmail(email))
        {
            message = "Invalid email address";
            return;
        }

        // Call RegisterAsync which handles duplicates internally
        var result = await userDB.RegisterAsync(username, password, email);

        if (result.Success)
        {
            Nav.NavigateTo("/login");
        }
        else
        {
            message = result.Message;
        }
    }

    static bool IsValidEmail(string email)
    {
        return System.Text.RegularExpressions.Regex.IsMatch(
            email,
            @"\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b",
            System.Text.RegularExpressions.RegexOptions.IgnoreCase
        );
    }
}
