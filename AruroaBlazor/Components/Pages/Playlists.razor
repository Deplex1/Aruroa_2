@page "/playlists"
@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage Storage
@inject NavigationManager Nav

<h1>Your Playlists</h1>

@if (user == null)
{
    <p>You must be logged in to see playlists.</p>
}
else
{
    <!-- Create New Playlist Section -->
    <div class="create-playlist-section">
        <h2>Create New Playlist</h2>
        <div class="create-playlist-form">
            <div class="form-group">
                <label for="playlistName">Playlist Name</label>
                <input id="playlistName" placeholder="Enter playlist name..." @bind="newPlaylistName" />
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="isPublic" />
                    <span>Make this playlist public</span>
                </label>
            </div>
            
            <button @onclick="CreatePlaylist" class="btn" disabled="@(string.IsNullOrWhiteSpace(newPlaylistName))">
                Create Playlist
            </button>
        </div>
        
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="message @(message.Contains("success") ? "message-success" : "message-error")">
                @message
            </div>
        }
    </div>

    <hr />

    <!-- Playlists Grid -->
    <div class="playlists-section">
        <h2>Your Playlists</h2>
        
        @if (userPlaylists.Count == 0)
        {
            <div class="no-playlists">
                <p>No playlists yet. Create your first playlist above!</p>
            </div>
        }
        else
        {
            <div class="playlists-grid">
                @foreach (var playlist in userPlaylists)
                {
                    <div class="playlist-card">
                        <div class="playlist-header">
                            <h3>@playlist.name</h3>
                            <span class="playlist-status @(playlist.ispublic ? "public" : "private")">
                                @(playlist.ispublic ? "🌐 Public" : "🔒 Private")
                            </span>
                        </div>
                        
                        <div class="playlist-info">
                            <p>Songs: @GetSongCount(playlist.playlistid)</p>
                        </div>
                        
                        <div class="playlist-actions">
                            <button @onclick="() => ViewPlaylist(playlist.playlistid)" class="btn btn-secondary">
                                View Songs
                            </button>
                            <button @onclick="() => DeletePlaylist(playlist.playlistid)" class="btn btn-danger">
                                Delete
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Selected Playlist Songs -->
    @if (selectedPlaylist != null)
    {
        <hr />
        <div class="selected-playlist-section">
            <h2>Songs in @selectedPlaylist.name</h2>
            
            @if (playlistSongs.Count == 0)
            {
                <div class="no-songs">
                    <p>No songs in this playlist.</p>
                    <button @onclick="GoToSongs" class="btn btn-secondary">Add Songs</button>
                </div>
            }
            else
            {
                <div class="songs-list">
                    @foreach (var song in playlistSongs)
                    {
                        <div class="song-item">
                            <div class="song-info">
                                <h4>@song.title</h4>
                                <p>Duration: @FormatDuration(song.duration)</p>
                            </div>
                            
                            @{
                                var audioSource = song.GetAudioSource(song.audioData);
                            }
                            @if (!string.IsNullOrEmpty(audioSource))
                            {
                                <div class="audio-container">
                                    <audio controls preload="none">
                                        <source src="@audioSource" type="audio/mpeg" />
                                        <source src="@audioSource" type="audio/mp3" />
                                    </audio>
                                </div>
                            }
                            
                            <button @onclick="() => RemoveSongFromPlaylist(song.songID)" class="btn btn-danger btn-small">
                                Remove
                            </button>
                        </div>
                    }
                </div>
            }
            
            <!-- Add Songs Section -->
            <hr />
            <div class="add-songs-section">
                <h3>Add More Songs</h3>
                <div class="add-songs-form">
                    <div class="song-selector">
                        <select @bind="selectedSongId" class="song-select">
                            <option value="0">-- Select a song --</option>
                            @foreach (var availableSong in allSongs.Where(s => !playlistSongs.Any(ps => ps.songID == s.songID)))
                            {
                                <option value="@availableSong.songID">@availableSong.title</option>
                            }
                        </select>
                        <button @onclick="() => AddSongToPlaylist()" class="btn btn-secondary" disabled="@(selectedSongId == 0 || isAddingSong)">
                            Add to Playlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private User? user;
    private List<Playlist> userPlaylists = new List<Playlist>();
    private Playlist? selectedPlaylist;
    private List<Song> playlistSongs = new List<Song>();
    private List<Song> allSongs = new List<Song>();

    private string newPlaylistName = "";
    private bool isPublic = true;
    private string message = "";
    private int selectedSongId = 0;
    private bool isAddingSong = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            user = result.Value;
            await LoadUserPlaylists();
            await LoadAllSongs();
            StateHasChanged();
        }
        else
        {
            user = null;
            userPlaylists = new List<Playlist>();
            allSongs = new List<Song>();
            StateHasChanged();
        }
    }

    private async Task LoadUserPlaylists()
    {
        if (user == null) return;

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            userPlaylists = await playlistDB.GetUserPlaylistsAsync(user.userid);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading playlists: {ex.Message}");
        }
    }

    private async Task LoadAllSongs()
    {
        try
        {
            SongDB songDB = new SongDB();
            allSongs = await songDB.SelectAllSongsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading songs: {ex.Message}");
        }
    }

    private async Task CreatePlaylist()
    {
        if (user == null || string.IsNullOrWhiteSpace(newPlaylistName))
        {
            return;
        }

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            Playlist newPlaylist = new Playlist
            {
                name = newPlaylistName.Trim(),
                userid = user.userid,
                ispublic = isPublic
            };

            int result = await playlistDB.AddPlaylistAsync(newPlaylist);
            
            if (result > 0)
            {
                message = "Playlist created successfully!";
                newPlaylistName = "";
                isPublic = true;
                await LoadUserPlaylists();
                StateHasChanged();
            }
            else
            {
                message = "Error creating playlist. Please try again.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error creating playlist: {ex.Message}";
        }
    }

    private async Task ViewPlaylist(int playlistId)
    {
        try
        {
            selectedPlaylist = userPlaylists.FirstOrDefault(p => p.playlistid == playlistId);
            if (selectedPlaylist != null)
            {
                await LoadPlaylistSongs(playlistId);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error viewing playlist: {ex.Message}");
        }
    }

    private async Task LoadPlaylistSongs(int playlistId)
    {
        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            var playlistSongRelations = await playlistSongDB.GetSongsInPlaylistAsync(playlistId);
            
            playlistSongs.Clear();
            foreach (var relation in playlistSongRelations)
            {
                var song = allSongs.FirstOrDefault(s => s.songID == relation.songid);
                if (song != null)
                {
                    playlistSongs.Add(song);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading playlist songs: {ex.Message}");
        }
    }

    private async Task DeletePlaylist(int playlistId)
    {
        if (user == null) return;

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            await playlistDB.DeletePlaylistAsync(playlistId);
            
            userPlaylists.RemoveAll(p => p.playlistid == playlistId);
            if (selectedPlaylist?.playlistid == playlistId)
            {
                selectedPlaylist = null;
                playlistSongs.Clear();
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting playlist: {ex.Message}");
        }
    }

    private async Task RemoveSongFromPlaylist(int songId)
    {
        if (selectedPlaylist == null) return;

        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            await playlistSongDB.RemoveSongFromPlaylistAsync(selectedPlaylist.playlistid, songId);
            
            playlistSongs.RemoveAll(s => s.songID == songId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing song from playlist: {ex.Message}");
        }
    }

    private int GetSongCount(int playlistId)
    {
        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            return playlistSongDB.GetSongCountAsync(playlistId).Result;
        }
        catch
        {
            return 0;
        }
    }

    private string FormatDuration(int seconds)
    {
        int minutes = seconds / 60;
        int secs = seconds % 60;
        return $"{minutes}:{secs:D2}";
    }

    private async Task AddSongToPlaylist()
    {
        if (selectedPlaylist == null || selectedSongId == 0)
        {
            return;
        }

        if (isAddingSong) return;
        isAddingSong = true;

        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            bool exists = await playlistSongDB.SongExistsInPlaylistAsync(selectedPlaylist.playlistid, selectedSongId);
            if (exists)
            {
                message = "Song is already in this playlist.";
                return;
            }
            
            // Get the next position for the song
            int nextPosition = playlistSongs.Count + 1;
            
            int rows = await playlistSongDB.AddSongToPlaylistAsync(selectedPlaylist.playlistid, selectedSongId, nextPosition);
            if (rows != 1)
            {
                message = "Error adding song to playlist.";
                return;
            }
            
            // Reload the playlist songs
            await LoadPlaylistSongs(selectedPlaylist.playlistid);
            
            // Reset selection
            selectedSongId = 0;
            
            message = "Song added to playlist successfully!";
            StateHasChanged();
            
            // Clear message after 2 seconds
            await Task.Delay(2000);
            message = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Error adding song to playlist: {ex.Message}";
            Console.WriteLine($"Error adding song to playlist: {ex}");
        }
        finally
        {
            isAddingSong = false;
            StateHasChanged();
        }
    }

    private void GoToSongs()
    {
        Nav.NavigateTo("/songs");
    }
}
