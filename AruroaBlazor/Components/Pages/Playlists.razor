@page "/playlists"
@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage Storage
@inject NavigationManager Nav

<h1>Your Playlists</h1>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (user == null)
{
    <p>You must be logged in to see playlists.</p>
}
else
{
    <!-- Create New Playlist Section -->
    <div class="create-playlist-section">
        <h2>Create New Playlist</h2>
        <div class="create-playlist-form">
            <div class="form-group">
                <label for="playlistName">Playlist Name</label>
                <input id="playlistName" placeholder="Enter playlist name..." @bind="newPlaylistName" />
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" @bind="isPublic" />
                    <span>Make this playlist public</span>
                </label>
            </div>

            <button @onclick="CreatePlaylist" class="btn" disabled="@(string.IsNullOrWhiteSpace(newPlaylistName))">
                Create Playlist
            </button>
        </div>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="message @(message.Contains("success") ? "message-success" : "message-error")">
                @message
            </div>
        }
    </div>

    <hr />

    <!-- Playlists Grid -->
    <div class="playlists-section">
        <h2>Your Playlists</h2>

        @if (userPlaylists.Count == 0)
        {
            <div class="no-playlists">
                <p>No playlists yet. Create your first playlist above!</p>
            </div>
        }
        else
        {
            <div class="playlists-grid">
                @for (int i = 0; i < userPlaylists.Count; i++)
                {
                    Playlist playlist = userPlaylists[i];

                    <div class="playlist-card">
                        <div class="playlist-header">
                            <h3>@playlist.name</h3>
                            <span class="playlist-status @(playlist.ispublic ? "public" : "private")">
                                @(playlist.ispublic ? "🌐 Public" : "🔒 Private")
                            </span>
                        </div>

                        <div class="playlist-info">
                            <p>
                                Songs:
                                @{
                                    int count = 0;

                                    if (playlistSongCounts.ContainsKey(playlist.playlistid))
                                    {
                                        count = playlistSongCounts[playlist.playlistid];
                                    }
                                }
                                @count
                            </p>
                        </div>

                        <div class="playlist-actions">
                            <button @onclick="() => ViewPlaylist(playlist.playlistid)" class="btn btn-secondary">
                                View Songs
                            </button>
                            <button @onclick="() => DeletePlaylist(playlist.playlistid)" class="btn btn-danger">
                                Delete
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Selected Playlist Songs -->
    @if (selectedPlaylist != null)
    {
        <hr />
        <div class="selected-playlist-section">
            <h2>Songs in @selectedPlaylist.name</h2>

            @if (playlistSongs.Count == 0)
            {
                <div class="no-songs">
                    <p>No songs in this playlist.</p>
                    <button @onclick="GoToSongs" class="btn btn-secondary">Add Songs</button>
                </div>
            }
            else
            {
                <div class="songs-list">
                    @for (int i = 0; i < playlistSongs.Count; i++)
                    {
                        Song song = playlistSongs[i];

                        <div class="song-item">
                            <div class="song-info">
                                <h4>@song.title</h4>
                                <p>Duration: @FormatDuration(song.duration)</p>
                            </div>

                            @{
                                var audioSource = song.GetAudioSource(song.audioData);
                            }
                            @if (!string.IsNullOrEmpty(audioSource))
                            {
                                <div class="audio-container">
                                    <audio controls preload="none">
                                        <source src="@audioSource" type="audio/mpeg" />
                                        <source src="@audioSource" type="audio/mp3" />
                                    </audio>
                                </div>
                            }

                            <button @onclick="() => RemoveSongFromPlaylist(song.songID)" class="btn btn-danger btn-small">
                                Remove
                            </button>
                        </div>
                    }
                </div>
            }

            <!-- Add Songs Section -->
            <hr />
            <div class="add-songs-section">
                <h3>Add More Songs</h3>
                <div class="add-songs-form">
                    <div class="song-selector">
                        <select @bind="selectedSongId" class="song-select">
                            <option value="0">-- Select a song --</option>
                            @for (int i = 0; i < allSongs.Count; i++)
                            {
                                Song availableSong = allSongs[i];

                                // Check if this song is already in the playlist
                                bool alreadyInPlaylist = false;
                                for (int j = 0; j < playlistSongs.Count; j++)
                                {
                                    if (playlistSongs[j].songID == availableSong.songID)
                                    {
                                        alreadyInPlaylist = true;
                                        break;
                                    }
                                }

                                // Only show songs that aren't in the playlist yet
                                if (alreadyInPlaylist == false)
                                {
                                    <option value="@availableSong.songID">@availableSong.title</option>
                                }
                            }
                        </select>
                        <button @onclick="() => AddSongToPlaylist()" class="btn btn-secondary" disabled="@(selectedSongId == 0 || isAddingSong)">
                            Add to Playlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    // Currently logged-in user
    private User? user;
    private bool isLoading = true;

    // List of playlists belonging to the user
    private List<Playlist> userPlaylists = new List<Playlist>();

    // The playlist currently being viewed (null if none selected)
    private Playlist? selectedPlaylist;

    // Songs in the currently selected playlist
    private List<Song> playlistSongs = new List<Song>();

    // All songs available in the database (for adding to playlists)
    private List<Song> allSongs = new List<Song>();
    // Holds song count for each playlist (playlistId -> count)
private Dictionary<int, int> playlistSongCounts = new Dictionary<int, int>();

    // Form inputs
    private string newPlaylistName = "";
    private bool isPublic = true;
    private string message = "";
    private int selectedSongId = 0;
    private bool isAddingSong = false;

    private bool hasLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (hasLoaded == false || firstRender)
        {
            hasLoaded = true;
            isLoading = true;
            // DON'T call StateHasChanged here!

            var result = await Storage.GetAsync<User>("user");

            if (result.Success)
            {
                user = result.Value;
                await LoadUserPlaylists();
                await LoadSongCountsAsync(); 
                await LoadAllSongs();
            }
            else
            {
                user = null;
                userPlaylists = new List<Playlist>();
                allSongs = new List<Song>();
            }

            isLoading = false;
            StateHasChanged();  // ← Only call it HERE at the end!
        }
    }

    

    // Load all playlists created by the logged-in user
    private async Task LoadUserPlaylists()
    {
        if (user == null)
        {
            return;
        }

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            userPlaylists = await playlistDB.GetUserPlaylistsAsync(user.userid);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading playlists: {ex.Message}");
        }
    }

    // Load all songs from database (needed for adding songs to playlists)
    private async Task LoadAllSongs()
    {
        try
        {
            SongDB songDB = new SongDB();
            allSongs = await songDB.SelectAllSongsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading songs: {ex.Message}");
        }
    }

    // Create a new playlist
    private async Task CreatePlaylist()
    {
        if (user == null)
        {
            return;
        }
        if (string.IsNullOrWhiteSpace(newPlaylistName))
        {
            return;
        }

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            Playlist newPlaylist = new Playlist
            {
                name = newPlaylistName.Trim(),
                userid = user.userid,
                ispublic = isPublic
            };

            int result = await playlistDB.AddPlaylistAsync(newPlaylist);

            if (result > 0)
            {
                message = "Playlist created successfully!";
                newPlaylistName = "";
                isPublic = true;
                await LoadUserPlaylists();
                StateHasChanged();
            }
            else
            {
                message = "Error creating playlist. Please try again.";
            }
        }
        catch (Exception ex)
        {
            message = $"Error creating playlist: {ex.Message}";
        }
    }

    // View a specific playlist and load its songs
    private async Task ViewPlaylist(int playlistId)
    {
        try
        {
            // Find the playlist in the user's playlist list
            selectedPlaylist = null;
            for (int i = 0; i < userPlaylists.Count; i++)
            {
                if (userPlaylists[i].playlistid == playlistId)
                {
                    selectedPlaylist = userPlaylists[i];
                    break;
                }
            }

            if (selectedPlaylist != null)
            {
                await LoadPlaylistSongs(playlistId);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error viewing playlist: {ex.Message}");
        }
    }

    // Load all songs that are in a specific playlist
    private async Task LoadPlaylistSongs(int playlistId)
    {
        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            var playlistSongRelations = await playlistSongDB.GetSongsInPlaylistAsync(playlistId);

            playlistSongs.Clear();

            // For each song ID in the playlist, find the full song object
            for (int i = 0; i < playlistSongRelations.Count; i++)
            {
                int songId = playlistSongRelations[i].songid;

                // Find the song in allSongs list
                for (int j = 0; j < allSongs.Count; j++)
                {
                    if (allSongs[j].songID == songId)
                    {
                        playlistSongs.Add(allSongs[j]);
                        break;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading playlist songs: {ex.Message}");
        }
    }

    // Delete a playlist
    private async Task DeletePlaylist(int playlistId)
    {
        if (user == null)
        {
            return;
        }

        try
        {
            PlaylistDB playlistDB = new PlaylistDB();
            await playlistDB.DeletePlaylistAsync(playlistId);

            // Remove from local list
            for (int i = 0; i < userPlaylists.Count; i++)
            {
                if (userPlaylists[i].playlistid == playlistId)
                {
                    userPlaylists.RemoveAt(i);
                    break;
                }
            }

            // If this was the selected playlist, deselect it
            if (selectedPlaylist != null && selectedPlaylist.playlistid == playlistId)
            {
                selectedPlaylist = null;
                playlistSongs.Clear();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting playlist: {ex.Message}");
        }
    }

    // Remove a song from the currently selected playlist
    private async Task RemoveSongFromPlaylist(int songId)
    {
        if (selectedPlaylist == null)
        {
            return;
        }

        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            await playlistSongDB.RemoveSongFromPlaylistAsync(selectedPlaylist.playlistid, songId);

            // Remove from local list
            for (int i = 0; i < playlistSongs.Count; i++)
            {
                if (playlistSongs[i].songID == songId)
                {
                    playlistSongs.RemoveAt(i);
                    break;
                }
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing song from playlist: {ex.Message}");
        }
    }

    // Get the number of songs in a playlist
    private async Task<int> GetSongCountAsync(int playlistId)
    {
        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();
            int count = await playlistSongDB.GetSongCountAsync(playlistId);
            return count;
        }
        catch
        {
            return 0;
        }
    }

    // Convert seconds to "minutes:seconds" format
    // Example: 125 seconds becomes "2:05"
    private string FormatDuration(int seconds)
    {
        int minutes = seconds / 60;
        int secs = seconds % 60;
        return $"{minutes}:{secs:D2}";
    }

    // Add the selected song to the currently selected playlist
    private async Task AddSongToPlaylist()
    {
        if (selectedPlaylist == null)
        {
            return;
        }
        if (selectedSongId == 0)
        {
            return;
        }

        if (isAddingSong)
        {
            return;
        }

        isAddingSong = true;

        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();

            // Check if song already exists in this playlist
            bool exists = await playlistSongDB.SongExistsInPlaylistAsync(selectedPlaylist.playlistid, selectedSongId);
            if (exists)
            {
                message = "Song is already in this playlist.";
                return;
            }

            // Get the next position for the song (last position + 1)
            int nextPosition = playlistSongs.Count + 1;

            // Add the song to the playlist
            int rows = await playlistSongDB.AddSongToPlaylistAsync(selectedPlaylist.playlistid, selectedSongId, nextPosition);
            if (rows != 1)
            {
                message = "Error adding song to playlist.";
                return;
            }

            // Reload the playlist songs to show the new addition
            await LoadPlaylistSongs(selectedPlaylist.playlistid);

            // Reset selection
            selectedSongId = 0;

            message = "Song added to playlist successfully!";
            StateHasChanged();

            // Clear message after 2 seconds
            await Task.Delay(2000);
            message = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Error adding song to playlist: {ex.Message}";
            Console.WriteLine($"Error adding song to playlist: {ex}");
        }
        finally
        {
            isAddingSong = false;
            StateHasChanged();
        }
    }

    // Load song counts for all playlists at once
    private async Task LoadSongCountsAsync()
    {
        playlistSongCounts.Clear();

        try
        {
            PlaylistSongDB playlistSongDB = new PlaylistSongDB();

            for (int i = 0; i < userPlaylists.Count; i++)
            {
                int playlistId = userPlaylists[i].playlistid;

                int count = await playlistSongDB.GetSongCountAsync(playlistId);

                // Store the result so the UI can use it instantly
                playlistSongCounts[playlistId] = count;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error loading song counts: " + ex.Message);
        }
    }


    // Navigate to songs page
    private void GoToSongs()
    {   
        Nav.NavigateTo("/songs");
    }
}