@page "/adminDashboard/genreRequests"
@using Models
@using Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage Storage
@inject NavigationManager Nav

<div class="admin-page">

    @* ===== PAGE HEADER ===== *@
    <div class="page-header">
        <h1>Genre Requests</h1>
        <p class="page-subtitle">Review and approve user-submitted genre requests</p>
    </div>

    @* ===== NOT LOGGED IN ===== *@
    @if (user == null && isLoading == false)
    {
        <div class="alert alert-warning">
            <h3>Not Logged In</h3>
            <p>You must be logged in to view this page.</p>
            <button class="btn btn-primary" @onclick="GoToLogin">Go to Login</button>
        </div>
    }

    @* ===== NOT ADMIN ===== *@
    else if (user != null && user.IsAdmin != 1 && isLoading == false)
    {
        <div class="alert alert-danger">
            <h3>Access Denied</h3>
            <p>You do not have permission to view this page.</p>
            <p>This area is for administrators only.</p>
        </div>
    }

    @* ===== LOADING STATE ===== *@
    else if (isLoading)
    {
        <div class="loading-section">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
        </div>
    }

    @* ===== ADMIN CONTENT ===== *@
    else
    {
        @* Success or error message after approving/rejecting *@
        @if (string.IsNullOrEmpty(message) == false)
        {
            <div class="alert @messageClass">
                @message
            </div>
        }

        @* Stats bar showing how many pending requests *@
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-number">@pendingRequests.Count</span>
                <span class="stat-label">Pending Requests</span>
            </div>
            <button class="btn btn-secondary" @onclick="RefreshRequests">
                Refresh
            </button>
        </div>

        @* ===== PENDING REQUESTS LIST ===== *@
        @if (pendingRequests.Count == 0)
        {
            <div class="empty-state">
                <div class="empty-icon">✅</div>
                <h3>All caught up!</h3>
                <p>There are no pending genre requests right now.</p>
            </div>
        }
        else
        {
            <div class="requests-list">
                @for (int i = 0; i < pendingRequests.Count; i++)
                {
                    GenreRequest request = pendingRequests[i];

                    <div class="request-card">

                        @* Genre name being requested *@
                        <div class="request-genre-name">
                            @request.genre_name
                        </div>

                        @* Request details *@
                        <div class="request-details">
                            <div class="request-detail-item">
                                <span class="detail-label">Requested by:</span>
                                <span class="detail-value">User #@request.userid</span>
                            </div>
                            <div class="request-detail-item">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value">
                                    @request.requested_date.ToString("MMM dd, yyyy")
                                    at @request.requested_date.ToString("HH:mm")
                                </span>
                            </div>
                            <div class="request-detail-item">
                                <span class="detail-label">Status:</span>
                                <span class="badge badge-pending">@request.status</span>
                            </div>
                        </div>

                        @* Approve and Reject buttons *@
                        <div class="request-actions">
                            <button class="btn btn-approve"
                                    @onclick="() => ApproveRequest(request)"
                                    disabled="@isProcessing">
                                @if (isProcessing && processingRequestId == request.requestid)
                                {
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>✓ Approve</span>
                                }
                            </button>

                            <button class="btn btn-reject"
                                    @onclick="() => RejectRequest(request)"
                                    disabled="@isProcessing">
                                @if (isProcessing && processingRequestId == request.requestid)
                                {
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>✕ Reject</span>
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    }
</div>

<style>
    .admin-page {
        max-width: 900px;
        margin: 0 auto;
        padding: 30px 20px;
    }

    /* ===== HEADER ===== */
    .page-header {
        margin-bottom: 30px;
    }

        .page-header h1 {
            font-size: 32px;
            color: #2c3e50;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

    .page-subtitle {
        color: #7f8c8d;
        font-size: 16px;
        margin: 0;
    }

    /* ===== ALERTS ===== */
    .alert {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

        .alert h3 {
            margin: 0 0 8px 0;
        }

        .alert p {
            margin: 4px 0;
        }

    .alert-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
    }

    .alert-danger {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    .alert-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
    }

    .alert-error {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    /* ===== STATS BAR ===== */
    .stats-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        font-size: 14px;
        color: #7f8c8d;
        font-weight: 500;
    }

    /* ===== REQUEST CARDS ===== */
    .requests-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .request-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

        .request-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
        }

    .request-genre-name {
        font-size: 24px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
    }

    .request-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 20px;
    }

    .request-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .detail-label {
        color: #7f8c8d;
        font-weight: 500;
        min-width: 100px;
    }

    .detail-value {
        color: #2c3e50;
    }

    /* ===== BADGES ===== */
    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffc107;
    }

    /* ===== ACTION BUTTONS ===== */
    .request-actions {
        display: flex;
        gap: 12px;
    }

    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

    .btn-approve {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        flex: 1;
    }

        .btn-approve:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

    .btn-reject {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        flex: 1;
    }

        .btn-reject:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

    /* ===== EMPTY STATE ===== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }

    .empty-state h3 {
        color: #2c3e50;
        margin: 0 0 8px 0;
        font-size: 22px;
    }

    .empty-state p {
        color: #7f8c8d;
        margin: 0;
    }

    /* ===== SKELETON LOADING ===== */
    .loading-section {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .skeleton-card {
        height: 160px;
        border-radius: 12px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s ease-in-out infinite;
    }

    @@keyframes shimmer {
        0%

    {
        background-position: 200% 0;
    }

    100% {
        background-position: -200% 0;
    }

    }
</style>

@code {
    // Service that handles all genre request logic
    private GenreRequestService requestService = new GenreRequestService();

    // Current logged-in user
    private User user = null;

    // List of pending genre requests
    private List<GenreRequest> pendingRequests = new List<GenreRequest>();

    // Loading states
    private bool isLoading = true;
    private bool isProcessing = false;

    // Track which request is being processed
    // So we can show "Processing..." on the right button
    private int processingRequestId = -1;

    // Message to show after approve/reject
    private string message = "";
    private string messageClass = "";

    // Called after component renders for first time
    protected override async Task OnAfterRenderAsync(bool first)
    {
        if (first == false)
        {
            return;
        }

        // Show skeleton loading
        isLoading = true;
        StateHasChanged();

        // Get logged-in user from session storage
        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            user = result.Value;
        }
        else
        {
            user = null;
        }

        // Only load requests if user is admin
        if (user != null && user.IsAdmin == 1)
        {
            await LoadRequests();
        }

        // Hide skeleton loading
        isLoading = false;
        StateHasChanged();
    }

    // Load all pending requests from database
    private async Task LoadRequests()
    {
        try
        {
            pendingRequests = await requestService.GetPendingRequestsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading requests: {ex.Message}");
            ShowMessage("Error loading requests. Please try again.", "alert-error");
        }
    }

    // Refresh the requests list
    private async Task RefreshRequests()
    {
        isLoading = true;
        StateHasChanged();

        await LoadRequests();

        isLoading = false;
        StateHasChanged();
    }

    // Approve a genre request
    private async Task ApproveRequest(GenreRequest request)
    {
        // Prevent double clicking
        if (isProcessing)
        {
            return;
        }

        // Validate admin access
        string error = requestService.ValidateAdminAccess(user);
        if (error != null)
        {
            ShowMessage(error, "alert-error");
            return;
        }

        // Mark as processing
        isProcessing = true;
        processingRequestId = request.requestid;
        StateHasChanged();

        try
        {
            bool success = await requestService.ApproveRequestAsync(request.requestid, user.userid);

            if (success)
            {
                // Remove from the list so UI updates immediately
                requestService.RemoveRequestFromList(pendingRequests, request.requestid);

                // Show success message
                ShowMessage($"Genre '{request.genre_name}' approved and created successfully!", "alert-success");

                // Clear message after 4 seconds
                await Task.Delay(4000);
                message = "";
                StateHasChanged();
            }
            else
            {
                ShowMessage($"Failed to approve '{request.genre_name}'. Please try again.", "alert-error");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error approving request: {ex.Message}");
            ShowMessage("An error occurred. Please try again.", "alert-error");
        }
        finally
        {
            // Always reset processing state
            isProcessing = false;
            processingRequestId = -1;
            StateHasChanged();
        }
    }

    // Reject a genre request
    private async Task RejectRequest(GenreRequest request)
    {
        // Prevent double clicking
        if (isProcessing)
        {
            return;
        }

        // Validate admin access
        string error = requestService.ValidateAdminAccess(user);
        if (error != null)
        {
            ShowMessage(error, "alert-error");
            return;
        }

        // Mark as processing
        isProcessing = true;
        processingRequestId = request.requestid;
        StateHasChanged();

        try
        {
            bool success = await requestService.RejectRequestAsync(request.requestid, user.userid);

            if (success)
            {
                // Remove from the list so UI updates immediately
                requestService.RemoveRequestFromList(pendingRequests, request.requestid);

                // Show message
                ShowMessage($"Genre request '{request.genre_name}' has been rejected.", "alert-success");

                // Clear message after 4 seconds
                await Task.Delay(4000);
                message = "";
                StateHasChanged();
            }
            else
            {
                ShowMessage($"Failed to reject '{request.genre_name}'. Please try again.", "alert-error");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rejecting request: {ex.Message}");
            ShowMessage("An error occurred. Please try again.", "alert-error");
        }
        finally
        {
            // Always reset processing state
            isProcessing = false;
            processingRequestId = -1;
            StateHasChanged();
        }
    }

    // Show a message to the admin
    private void ShowMessage(string text, string cssClass)
    {
        message = text;
        messageClass = cssClass;
        StateHasChanged();
    }

    // Navigate to login page
    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }
}