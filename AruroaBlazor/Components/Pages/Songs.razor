@page "/songs"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h1>Songs</h1>

<!-- Search and Filter Section -->
<div class="search-section">
    <div class="search-controls">
        <div class="search-input-group">
            <input placeholder="Search songs by title..." @bind="searchText" @oninput="OnSearchInput" class="search-input" />
            <button @onclick="Search" class="btn btn-search">Search</button>
            <button @onclick="ClearSearch" class="btn btn-secondary">Clear</button>
        </div>
        
        <div class="results-info">
            @if (!string.IsNullOrEmpty(searchText))
            {
                <span>Found @songList.Count songs matching "@searchText"</span>
            }
            else
            {
                <span>All Songs (@songList.Count)</span>
            }
        </div>
    </div>
</div>

<hr />

<!-- Songs List -->
@if (songList == null)
{
    <div class="loading">
        <p>Loading songs...</p>
    </div>
}
else if (songList.Count == 0)
{
    <div class="no-results">
        <p>No songs found.</p>
        @if (!string.IsNullOrEmpty(searchText))
        {
            <button @onclick="ClearSearch" class="btn btn-secondary">Show All Songs</button>
        }
    </div>
}
else
{
    <div class="songs-grid">
        @foreach (Song song in songList)
        {
            <div class="song-card">
                <div class="song-header">
                    <h4>@song.title</h4>
                    <div class="song-meta">
                        <span class="duration">Duration: @FormatDuration(song.duration)</span>
                        <span class="plays">Plays: @song.plays</span>
                    </div>
                </div>
                
                @{
                    var audioSource = song.GetAudioSource(song.audioData);
                }
                @if (!string.IsNullOrEmpty(audioSource))
                {
                    <div class="audio-container">
                        <audio controls preload="none" style="width: 100%;">
                            <source src="@audioSource" />
                            Your browser does not support the audio element.
                        </audio>
                        <div class="audio-debug">
                            <small>Audio data size: @(song.audioData?.Length ?? 0) bytes</small>
                        </div>
                    </div>
                }
                else
                {
                    <p class="no-audio">No audio data available</p>
                }

                <div class="song-actions">
                    <div class="star-rating">
                        @for (int i = 1; i <= 5; i++)
                        {
                            <span class="star @(IsStarFilled(song.songID, i) ? "filled" : "")"
                                  @onmouseover="() => OnHover(song.songID, i)"
                                  @onmouseout="() => OnHover(song.songID, 0)"
                                  @onclick="() => OnClick(song.songID, i)">
                                ★
                            </span>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@code
{
    // List of songs shown on the page
    private List<Song> songList = new List<Song>();

    // Text the user types into the search box
    private string searchText = "";
    
    // User information for ratings
    private User? currentUser;

    protected override async Task OnAfterRenderAsync(bool first)
    {
        if(first)
        {
            await LoadCurrentUser();
            await LoadAllSongs();
        }
    }

    private async Task LoadCurrentUser()
    {
        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            currentUser = result.Value;
            await LoadUserRatings();
        }
        else
        {
            currentUser = null;
        }
    }

    // Load all songs when the page opens
    private async Task LoadAllSongs()
    {
        try
        {
            SongDB db = new SongDB();
            songList = await db.SelectAllSongsAsync();
            await LoadUserRatings();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading songs: {ex.Message}");
        }
    }

    // Real-time search as user types
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(searchText))
        {
            await LoadAllSongs();
        }
    }

    // Search for songs by title
    private async Task Search()
    {
        try
        {
            SongDB db = new SongDB();
            songList = await db.SearchSongsAsync(searchText.Trim());
            await LoadUserRatings();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching songs: {ex.Message}");
        }
    }

    // Clear search and show all songs
    private async Task ClearSearch()
    {
        searchText = "";
        await LoadAllSongs();
    }

    void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login");
    }

    // Convert seconds to "m:ss" format (easy to read)
    string FormatDuration(int seconds)
    {
        int minutes = seconds / 60;
        int secs = seconds % 60;
        return minutes.ToString() + ":" + secs.ToString("00");
    }

    // RATING SYSTEM

    // stores the rating the user has clicked (songId -> value)
    private Dictionary<int, int> userRatings = new Dictionary<int, int>();

    // stores the temporary hover preview (songId -> value)
    private Dictionary<int, int> previewRatings = new Dictionary<int, int>();

    // Load user's existing ratings from database
    private async Task LoadUserRatings()
    {
        if (currentUser == null) return;

        try
        {
            RatingDB ratingDB = new RatingDB();
            var ratings = await ratingDB.GetUserRatingsAsync(currentUser.userid);
            
            userRatings.Clear();
            foreach (var rating in ratings)
            {
                userRatings[rating.songid] = rating.rating;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading user ratings: {ex.Message}");
        }
    }

    // Called when the mouse moves over or out of a star.
    void OnHover(int songId, int value)
    {
        if (value > 0)
        {
            previewRatings[songId] = value;
        }
        else
        {
            previewRatings.Remove(songId);
        }
        StateHasChanged();
    }

    // Called when the user clicks a star to pick a rating.
    private async Task OnClick(int songId, int value)
    {
        if (currentUser == null)
        {
            // You could show a message here asking user to login
            return;
        }

        try
        {
            RatingDB ratingDB = new RatingDB();
            await ratingDB.SaveRatingAsync(currentUser.userid, songId, value);
            
            userRatings[songId] = value;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving rating: {ex.Message}");
        }
    }

    // Decide if a star should look filled:
    bool IsStarFilled(int songId, int starIndex)
    {
        if (previewRatings.ContainsKey(songId) && previewRatings[songId] > 0)
            return starIndex <= previewRatings[songId];

        if (userRatings.ContainsKey(songId))
            return starIndex <= userRatings[songId];

        return false;
    }
}
