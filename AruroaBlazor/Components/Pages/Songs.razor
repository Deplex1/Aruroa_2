@page "/songs"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Services

@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<link href="css/songs.css" rel="stylesheet" />

<div class="songs-page-wrapper">
    <div class="songs-main-section">
        <div class="page-header">
            <h1>Songs</h1>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <input placeholder="Search songs..." @bind="searchText" @oninput="OnSearchInput" />
            <button @onclick="Search">Search</button>
            <button @onclick="ClearSearch">Clear</button>
        </div>

        <hr class="divider" />

        @if (songList == null)
        {
            <p class="loading-message">Loading songs...</p>
        }
        else if (songList.Count == 0)
        {
            <p class="no-songs-message">No songs found.</p>
        }
        else
        {
            @for (int i = 0; i < songList.Count; i++)
            {
                Song song = songList[i];

                // Get rating stats from dictionary (already loaded from SQL)
                double avgRating = 0;
                int ratingCount = 0;
                if (ratingStats.ContainsKey(song.songID))
                {
                    avgRating = ratingStats[song.songID].average;
                    ratingCount = ratingStats[song.songID].count;
                }

                <div class="song-card @GetSongCardClass(song.songID)">
                    <h3>@song.title</h3>
                    <p class="song-info">Duration: @uiHelper.FormatDuration(song.duration) | Plays: @song.plays | Avg: @uiHelper.FormatRating(avgRating) (@ratingCount ratings)</p>

                    @if (song.audioData != null)
                    {
                        <div class="action-buttons">
                            <button class="play-now-btn" @onclick="() => PlayNow(song)">
                                ▶ Play Now
                            </button>
                            <button class="add-to-queue-btn" @onclick="() => AddToQueue(song)">
                                + Add to Queue
                            </button>
                        </div>
                    }

                    <!-- Star rating -->
                    <div class="stars-section">
                        <div class="stars">
                            @if (currentUser == null)
                            {
                                @for (int s = 1; s <= 5; s++)
                                {
                                    int currentStar = s;
                                    string starClass = GetStarClassForDisplay(song.songID, currentStar);

                                    <span class="star @starClass disabled">
                                        ★
                                    </span>
                                }
                            }
                            else
                            {
                                @for (int s = 1; s <= 5; s++)
                                {
                                    int currentStar = s;
                                    string starClass = GetStarClass(song.songID, currentStar);

                                    <span class="star @starClass"
                                          @onmouseover="() => OnHover(song.songID, currentStar)"
                                          @onmouseout="() => OnHover(song.songID, 0)"
                                          @onclick="() => OnClick(song.songID, currentStar)">
                                        ★
                                    </span>
                                }
                            }
                        </div>

                        @if (currentUser == null)
                        {
                            <div class="login-notice">
                                Please <a @onclick="GoToLogin">log in</a> to rate songs
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code
{
    // Service instances
    private SongService songService = new SongService();
    private UIHelperService uiHelper = new UIHelperService();

    // NOTE: No GlobalAudioPlayerService variable needed!
    // Since it is STATIC, we call it directly:
    // GlobalAudioPlayerService.PlayNow(song)
    // GlobalAudioPlayerService.AddToQueue(song)
    // etc.

    // UI state variables
    private List<Song> songList = new List<Song>();
    private List<Rating> allRatings = new List<Rating>();
    private Dictionary<int, (double average, int count)> ratingStats = new Dictionary<int, (double, int)>();
    private string searchText = "";
    private User? currentUser;
    private Dictionary<int, int> userRatings = new Dictionary<int, int>();
    private Dictionary<int, int> previewRatings = new Dictionary<int, int>();

    // Currently playing song ID (from global player)
    private int currentlyPlayingSongId = -1;

    // Lifecycle method - loads data on first render
    protected override async Task OnAfterRenderAsync(bool first)
    {
        if (first)
        {
            await LoadCurrentUser();
            await LoadAllSongs();

            // Subscribe to player state changes
            // When the player changes song, pause, etc. this page updates too
            GlobalAudioPlayerService.OnStateChanged += OnPlayerStateChanged;

            StateHasChanged();
        }
    }

    // Called when global player state changes
    // Uses InvokeAsync to switch back to Blazor's UI thread
    // This is REQUIRED because the event fires from a different thread
    private void OnPlayerStateChanged()
    {
        // InvokeAsync switches execution back to Blazor's UI dispatcher thread
        // Without this, StateHasChanged() crashes because it needs to be
        // called from the same thread that Blazor uses for rendering
        InvokeAsync(() =>
        {
            Song? currentSong = GlobalAudioPlayerService.GetCurrentSong();
            if (currentSong != null)
            {
                currentlyPlayingSongId = currentSong.songID;
            }
            else
            {
                currentlyPlayingSongId = -1;
            }
            StateHasChanged();
        });
    }

    // Load current user from session storage
    private async Task LoadCurrentUser()
    {
        var result = await Storage.GetAsync<User>("user");
        if (result.Success)
        {
            currentUser = result.Value;
        }
        else
        {
            currentUser = null;
        }
    }

    // Load all songs from database using service
    private async Task LoadAllSongs()
    {
        songList = await songService.LoadAllSongsAsync();
        allRatings = await songService.LoadAllRatingsForSongsAsync(songList);
        ratingStats = await songService.GetRatingStatsForSongsAsync(songList);

        if (currentUser != null)
        {
            userRatings = await songService.LoadUserRatingsAsync(currentUser.userid);
        }

        StateHasChanged();
    }

    // Called when user types in the search box
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(searchText))
        {
            await LoadAllSongs();
        }
    }

    // Search for songs using service
    private async Task Search()
    {
        songList = await songService.SearchSongsAsync(searchText.Trim());
        allRatings = await songService.LoadAllRatingsForSongsAsync(songList);
        ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
        StateHasChanged();
    }

    // Clear search and show all songs again
    private async Task ClearSearch()
    {
        searchText = "";
        await LoadAllSongs();
    }

    // Play a song immediately using global static player
    private async Task PlayNow(Song song)
    {
        // Call static method directly - no instance needed!
        GlobalAudioPlayerService.PlayNow(song);

        // Increment play count in background
        await songService.IncrementPlayCountAsync(song.songID);
    }

    // Add a song to the play queue without playing
    private void AddToQueue(Song song)
    {
        // Call static method directly - no instance needed!
        GlobalAudioPlayerService.AddToQueue(song);
    }

    // Get CSS class for song card (highlight if currently playing)
    private string GetSongCardClass(int songId)
    {
        if (songId == currentlyPlayingSongId)
        {
            return "currently-playing";
        }
        return "";
    }

    // Navigate to login page
    private void GoToLogin()
    {
        Nav.NavigateTo("/login");
    }

    // Called when mouse hovers over a star
    void OnHover(int songId, int value)
    {
        if (value > 0)
        {
            previewRatings[songId] = value;
        }
        else
        {
            previewRatings.Remove(songId);
        }
        StateHasChanged();
    }

    // Called when user clicks a star to rate a song
    private async Task OnClick(int songId, int value)
    {
        if (currentUser == null)
        {
            return;
        }

        bool success = await songService.SaveRatingAsync(currentUser.userid, songId, value);

        if (success)
        {
            userRatings[songId] = value;

            bool exists = false;
            for (int i = 0; i < allRatings.Count; i++)
            {
                if (allRatings[i].songid == songId && allRatings[i].userid == currentUser.userid)
                {
                    allRatings[i].rating = value;
                    exists = true;
                }
            }

            if (exists == false)
            {
                allRatings.Add(new Rating
                {
                    songid = songId,
                    userid = currentUser.userid,
                    rating = value,
                    daterated = System.DateTime.Now
                });
            }

            ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
            StateHasChanged();
        }
    }

    // Determine star CSS class for logged-in users
    string GetStarClass(int songId, int starIndex)
    {
        if (previewRatings.ContainsKey(songId))
        {
            int hoverValue = previewRatings[songId];
            if (starIndex <= hoverValue)
            {
                return "filled";
            }
            else
            {
                return "gray";
            }
        }

        if (userRatings.ContainsKey(songId))
        {
            int userValue = userRatings[songId];
            if (starIndex <= userValue)
            {
                return "filled";
            }
            else
            {
                return "gray";
            }
        }

        return "gray";
    }

    // Determine star CSS class for non-logged users (shows average)
    string GetStarClassForDisplay(int songId, int starIndex)
    {
        double avgRating = 0;
        if (ratingStats.ContainsKey(songId))
        {
            avgRating = ratingStats[songId].average;
        }

        if (avgRating > 0)
        {
            int roundedAvg = (int)Math.Round(avgRating);
            if (starIndex <= roundedAvg)
            {
                return "filled";
            }
            else
            {
                return "gray";
            }
        }

        return "gray";
    }
}