@page "/songs"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<h3>Songs</h3>

<input placeholder="Search song..." @bind="searchTerm" />
<button @onclick="Search">Search</button>

<hr />

@if (songs != null)
{
    foreach (Song s in songs)
    {
        <div>
            <b>@s.title</b><br />

            Duration: @FormatDuration(s.duration)<br />

            <audio controls src="@GetAudioSource(s.audioData)"></audio>

            <hr />
        </div>
    }
}

<button @onclick="GoUpload">Upload Song</button>
<button @onclick="Logout">Logout</button>

@code
{
    List<Song> songs = new List<Song>();
    string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        SongDB db = new SongDB();
        songs = await db.SelectAllSongsAsync();
    }

    async Task Search()
    {
        SongDB db = new SongDB();
        songs = await db.SearchSongsAsync(searchTerm);
    }

    void GoUpload()
    {
        Nav.NavigateTo("/upload");
    }

    async Task Logout()
    {
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login");
    }

    string GetAudioSource(byte[] data)
    {
        if (data == null || data.Length == 0)
        {
            return "";
        }

        string base64 = Convert.ToBase64String(data);
        return "data:audio/mpeg;base64," + base64;
    }

    string FormatDuration(int seconds)
    {
        int min = seconds / 60;
        int sec = seconds % 60;

        return min.ToString() + ":" + sec.ToString("00");
    }
}
