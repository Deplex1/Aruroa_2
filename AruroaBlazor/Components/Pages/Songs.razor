@page "/songs"
@using DBL
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage

<link rel="stylesheet" href="C:\Users\Twelve.DESKTOP-MG3L518\source\repos\Aruroa\AruroaBlazor\wwwroot\star.css" />


<h3>Songs</h3>


<!-- Simple search input -->
<input placeholder="Search song..." @bind="searchText" />
<button @onclick="Search">Search</button>

<hr />

@if (songList != null)
{
    foreach (Song song in songList)
    {
        <div>
            <b>@song.title</b><br />

            Duration: @FormatDuration(song.duration)<br />

            <audio controls src="@song.GetAudioSource(song.audioData)"></audio>

            <div class="star-rating">
                @for (int i = 1; i <= 5; i++)
                {
                    <!-- show a filled star when appropriate -->
                    <span class="star @(IsStarFilled(song.songID, i) ? "filled" : "")"
                          @onmouseover="() => OnHover(song.songID, i)"
                          @onmouseout="() => OnHover(song.songID, 0)"
                          @onclick="() => OnClick(song.songID, i)">
                        ★
                    </span>
                }
            </div>

            <hr />
        </div>
    }
}

<button @onclick="GoUpload">Upload Song</button>
<button @onclick="Logout">Logout</button>

@code
{
    // List of songs shown on the page
    List<Song> songList = new List<Song>();

    // Text the user types into the search box
    string searchText = "";

    protected override async Task OnInitializedAsync()
    {
        // Load all songs when the page opens
        SongDB db = new SongDB();
        songList = await db.SelectAllSongsAsync();
    }

    // Search for songs by title (simple wrapper)
    async Task Search()
    {
        SongDB db = new SongDB();
        songList = await db.SearchSongsAsync(searchText);
    }

    void GoUpload()
    {
        // Navigate to the upload page
        Nav.NavigateTo("/upload");
    }

    async Task Logout()
    {
        // Remove the saved user and go to the login page
        await Storage.DeleteAsync("user");
        Nav.NavigateTo("/login");
    }

    // Convert seconds to "m:ss" format (easy to read)
    string FormatDuration(int seconds)
    {
        int minutes = seconds / 60;
        int secs = seconds % 60;
        return minutes.ToString() + ":" + secs.ToString("00");
    }

    //RATING

    // stores the rating the user has clicked (songId -> value)
    Dictionary<int, int> userRatings = new Dictionary<int, int>();

    // stores the temporary hover preview (songId -> value)
    Dictionary<int, int> previewRatings = new Dictionary<int, int>();

    // Called when the mouse moves over or out of a star.
    // If value is 0 we remove the preview so stale zeros don't stay.
    void OnHover(int songId, int value)
    {
        if (value > 0)
        {
            Console.WriteLine("Mouse Hoverd!", songId);
            previewRatings[songId] = value;
        }
        else
        {
            // remove preview when the mouse leaves the star area
            previewRatings.Remove(songId);
        }

        StateHasChanged();
    }

    // Called when the user clicks a star to pick a rating.
    // Right now this only updates local UI state. You can later
    // call a DB method here to save the rating permanently.
    async Task OnClick(int songId, int value)
    {
        userRatings[songId] = value;
        StateHasChanged();
    }

    // Decide if a star should look filled:
    // - show preview if the mouse is over stars
    // - otherwise show the saved user rating if present
    bool IsStarFilled(int songId, int starIndex)
    {
        if (previewRatings.ContainsKey(songId) && previewRatings[songId] > 0)
            return starIndex <= previewRatings[songId];

        if (userRatings.ContainsKey(songId))
            return starIndex <= userRatings[songId];

        return false;
    }
}
