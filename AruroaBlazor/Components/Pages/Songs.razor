@page "/songs"
@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Services
@using DBL

@inject NavigationManager Nav
@inject ProtectedSessionStorage Storage
@implements IDisposable

@* <link href="~/song.css" rel="stylesheet" /> *@

<div class="songs-page-wrapper">
    <div class="songs-main-section">
        <div class="page-header">
            <h1>Songs</h1>
        </div>

        <div class="genre-filter-section">
            <h4>Filter by Genre:</h4>
            <div class="genre-filter-list">
                @foreach (Genre genre in availableGenres)
                {
                    bool isSelected = IsGenreFilterSelected(genre.genreid);
                    <div class="genre-filter-item">
                        <input type="checkbox"
                               id="filter-@genre.genreid"
                               checked="@isSelected"
                               @onchange="(e) => ToggleGenreFilter(genre.genreid, e)" />
                        <label for="filter-@genre.genreid">@genre.name</label>
                    </div>
                }
            </div>
            <div class="filter-buttons">
                <button @onclick="ApplyGenreFilter" class="btn-filter">Apply Filter</button>
                <button @onclick="ClearGenreFilter" class="btn-filter-clear">Clear Filter</button>
            </div>
        </div>

        <div class="search-section">
            <input placeholder="Search songs..." @bind="searchText" @oninput="OnSearchInput" />
            <button @onclick="Search">Search</button>
            <button @onclick="ClearSearch">Clear</button>
        </div>

        <hr class="divider" />

        @if (songList == null)
        {
            <p class="loading-message">Loading songs...</p>
        }
        else if (songList.Count == 0)
        {
            <p class="no-songs-message">No songs found.</p>
        }
        else
        {
            @for (int i = 0; i < songList.Count; i++)
            {
                Song song = songList[i];

                double avgRating = 0;
                int ratingCount = 0;
                if (ratingStats.ContainsKey(song.songID))
                {
                    avgRating = ratingStats[song.songID].average;
                    ratingCount = ratingStats[song.songID].count;
                }

                <div class="song-card @GetSongCardClass(song.songID)">
                    <h3>@song.title</h3>

                    @if (songGenres.ContainsKey(song.songID))
                    {
                        <div class="genre-tags">
                            @foreach (Genre genre in songGenres[song.songID])
                            {
                                <span class="genre-tag">@genre.name</span>
                            }
                        </div>
                    }

                    <p class="song-info">
                        Duration: @uiHelper.FormatDuration(song.duration) |
                        Plays: @song.plays |
                        Avg: @uiHelper.FormatRating(avgRating) (@ratingCount ratings)
                    </p>

                    @if (song.audioData != null)
                    {
                        <div class="action-buttons">
                            <button class="play-now-btn" @onclick="() => PlayNow(song)">▶ Play Now</button>
                            <button class="add-to-queue-btn" @onclick="() => AddToQueue(song)">+ Add to Queue</button>
                        </div>
                    }

                    <div class="stars">
                        @for (int s = 1; s <= 5; s++)
                        {
                            int currentStar = s;
                            string starClass = GetStarClass(song.songID, currentStar);

                            <span class="star @starClass"
                                  @onmouseover="() => OnHover(song.songID, currentStar)"
                                  @onmouseout="() => OnHover(song.songID, 0)"
                                  @onclick="() => OnClick(song.songID, currentStar)">
                                ★
                            </span>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code
{
    private SongService songService = new SongService();
    private UIHelperService uiHelper = new UIHelperService();

    private List<Song> songList = new List<Song>();
    private Dictionary<int, (double average, int count)> ratingStats = new();
    private Dictionary<int, List<Genre>> songGenres = new();
    private List<Genre> availableGenres = new();
    private List<int> selectedFilterGenreIds = new();

    private string searchText = "";
    private User? currentUser;

    private Dictionary<int, int> userRatings = new();
    private Dictionary<int, int> previewRatings = new();

    private int currentlyPlayingSongId = -1;

    protected override async Task OnAfterRenderAsync(bool first)
    {
        if (first)
        {
            await LoadCurrentUser();
            await LoadAllSongs();

            GlobalAudioPlayerService.OnStateChanged += OnPlayerStateChanged;
            StateHasChanged();
        }
    }

    private void OnPlayerStateChanged()
    {
        InvokeAsync(() =>
        {
            Song? currentSong = GlobalAudioPlayerService.GetCurrentSong();
            currentlyPlayingSongId = currentSong != null ? currentSong.songID : -1;
            StateHasChanged();
        });
    }

    private async Task LoadCurrentUser()
    {
        var result = await Storage.GetAsync<User>("user");
        currentUser = result.Success ? result.Value : null;
    }

    private async Task LoadAllSongs()
    {
        songList = await songService.LoadAllSongsAsync();
        ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
        songGenres = await songService.LoadSongGenresAsync(songList);

        GenreDB genreDB = new GenreDB();
        availableGenres = await genreDB.SelectAllGenresAsync();

        if (currentUser != null)
        {
            userRatings = await songService.LoadUserRatingsAsync(currentUser.userid);
        }
    }

    private async Task Search()
    {
        songList = await songService.SearchSongsAsync(searchText.Trim());
        ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
        songGenres = await songService.LoadSongGenresAsync(songList);
    }

    private async Task OnClick(int songId, int value)
    {
        if (currentUser == null) return;

        bool success = await songService.SaveRatingAsync(currentUser.userid, songId, value);

        if (success)
        {
            userRatings[songId] = value;
            ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
            StateHasChanged();
        }
    }

    private void OnHover(int songId, int value)
    {
        if (value > 0)
        {
            previewRatings[songId] = value;
        }
        else
        {
            previewRatings.Remove(songId);
        }
    }

    string GetStarClass(int songId, int starIndex)
    {
        if (previewRatings.ContainsKey(songId))
        {
            return starIndex <= previewRatings[songId] ? "filled" : "gray";
        }

        if (userRatings.ContainsKey(songId))
        {
            return starIndex <= userRatings[songId] ? "filled" : "gray";
        }

        return "gray";
    }

    private async Task PlayNow(Song song)
    {
        GlobalAudioPlayerService.PlayNow(song);
        await songService.IncrementPlayCountAsync(song.songID);
    }

    private void AddToQueue(Song song)
    {
        GlobalAudioPlayerService.AddToQueue(song);
    }

    private string GetSongCardClass(int songId)
    {
        return songId == currentlyPlayingSongId ? "currently-playing" : "";
    }

    public void Dispose()
    {
        GlobalAudioPlayerService.OnStateChanged -= OnPlayerStateChanged;
    }

    // Called when user types in the search box
    private async Task OnSearchInput(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            searchText = e.Value.ToString();
        }
        else
        {
            searchText = "";
        }

        // If user cleared the search box we reload everything
        if (string.IsNullOrWhiteSpace(searchText))
        {
            await LoadAllSongs();
            StateHasChanged();
        }
    }


    // Clear search button
    private async Task ClearSearch()
    {
        searchText = "";
        await LoadAllSongs();
        StateHasChanged();
    }

    // Check if a genre checkbox is selected
    private bool IsGenreFilterSelected(int genreId)
    {
        for (int i = 0; i < selectedFilterGenreIds.Count; i = i + 1)
        {
            if (selectedFilterGenreIds[i] == genreId)
            {
                return true;
            }
        }

        return false;
    }

    // When user clicks a genre checkbox
    private void ToggleGenreFilter(int genreId, ChangeEventArgs e)
    {
        bool isChecked = false;

        if (e.Value != null)
        {
            isChecked = (bool)e.Value;
        }

        if (isChecked == true)
        {
            if (IsGenreFilterSelected(genreId) == false)
            {
                selectedFilterGenreIds.Add(genreId);
            }
        }
        else
        {
            for (int i = 0; i < selectedFilterGenreIds.Count; i = i + 1)
            {
                if (selectedFilterGenreIds[i] == genreId)
                {
                    selectedFilterGenreIds.RemoveAt(i);
                    break;
                }
            }
        }

        StateHasChanged();
    }

    // Apply genre filter button
    private async Task ApplyGenreFilter()
    {
        if (selectedFilterGenreIds.Count == 0)
        {
            await LoadAllSongs();
            return;
        }

        songList = await songService.FilterSongsByGenresAsync(selectedFilterGenreIds);
        ratingStats = await songService.GetRatingStatsForSongsAsync(songList);
        songGenres = await songService.LoadSongGenresAsync(songList);

        StateHasChanged();
    }

    // Clear genre filters button
    private async Task ClearGenreFilter()
    {
        selectedFilterGenreIds.Clear();
        await LoadAllSongs();
        StateHasChanged();
    }
}
