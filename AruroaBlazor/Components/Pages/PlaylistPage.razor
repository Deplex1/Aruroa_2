    @page "/playlist/{id:int}"

@using Models
@using DBL
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage Storage
@inject NavigationManager Nav

@if (user == null)
{
    <p>You must be logged in to view playlists.</p>
}
else
{
    if (playlist == null)
    {
        <p>Playlist not found.</p>
    }
    else
    {
        <h1>@playlist.name</h1>
        <p>@songs.Count songs</p>

        <button @onclick="PlayAll">Play All (NOT IMPLEMENTED YET)</button>
        <button @onclick="ToggleAddSongs">Add Songs</button>
        <button @onclick="Shuffle">Shuffle</button>

        @if (ShowAddSongs == true)
        {
            <select @bind="selectedSongId">
                <option value="0">-- Select song --</option>

                @foreach (Song s in filteredSongs)
                {
                    <option value="@s.songID">@s.title</option>
                }
            </select>

            <button @onclick="AddSongToPlaylist">Add</button>
        }

        @foreach (Song song in songs)
        {
            <div>
                <span>@song.title</span>
                <button @onclick="() => MoveUp(song)">Up</button>
                <button @onclick="() => MoveDown(song)">Down</button>
                <button @onclick="() => RemoveSong(song)">Remove</button>
            </div>
        }
    }
}

@code
{
    [Parameter]
    public int id { get; set; }

    private User user;
    private Playlist playlist;

    private List<Song> songs = new List<Song>();
    private List<Song> allSongs = new List<Song>();
    private List<Song> filteredSongs = new List<Song>();

    private bool ShowAddSongs = false;
    private int selectedSongId = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == false)
        {
            return;
        }

        var storedUser = await Storage.GetAsync<User>("user");

        if (storedUser.Success == true)
        {
            user = storedUser.Value;
        }
        else
        {
            user = null;
        }

        if (user != null)
        {
            await LoadPlaylist();
            await LoadAllSongs();
            StateHasChanged();
        }
    }

    private async Task LoadPlaylist()
    {
        PlaylistDB playlistDB = new PlaylistDB();
        playlist = await playlistDB.SelectByIdAsync(id);

        if (playlist == null)
        {
            songs.Clear();
            return;
        }

        PlaylistSongDB psDB = new PlaylistSongDB();
        List<PlaylistSong> playlistSongs = await psDB.GetSongsInPlaylistAsync(id);

        SongDB songDB = new SongDB();
        songs.Clear();

        for (int i = 0; i < playlistSongs.Count; i++)
        {
            PlaylistSong ps = playlistSongs[i];
            Song song = await songDB.SelectByIdAsync(ps.songid);

            if (song != null)
            {
                songs.Add(song);
            }
        }
    }

    private async Task LoadAllSongs()
    {
        SongDB songDB = new SongDB();
        allSongs = await songDB.SelectAllSongsAsync();
        FilterSongs();
    }

    private void ToggleAddSongs()
    {
        if (ShowAddSongs == true)
        {
            ShowAddSongs = false;
        }
        else
        {
            ShowAddSongs = true;
        }

        FilterSongs();
    }

    private void FilterSongs()
    {
        filteredSongs.Clear();

        for (int i = 0; i < allSongs.Count; i++)
        {
            Song candidate = allSongs[i];
            bool existsInPlaylist = false;

            for (int j = 0; j < songs.Count; j++)
            {
                if (songs[j].songID == candidate.songID)
                {
                    existsInPlaylist = true;
                }
            }

            if (existsInPlaylist == false)
            {
                filteredSongs.Add(candidate);
            }
        }
    }

    private async Task AddSongToPlaylist()
    {
        if (selectedSongId == 0)
        {
            return;
        }

        PlaylistSongDB psDB = new PlaylistSongDB();
        int maxPos = await psDB.GetMaxPositionInPlaylistAsync(id);
        int newPosition = maxPos + 1;

        await psDB.AddSongToPlaylistAsync(id, selectedSongId, newPosition);

        selectedSongId = 0;
        ShowAddSongs = false;

        await LoadPlaylist();
        FilterSongs();
    }

    private async Task RemoveSong(Song song)
    {
        PlaylistSongDB psDB = new PlaylistSongDB();
        await psDB.RemoveSongFromPlaylistAsync(id, song.songID);

        await LoadPlaylist();
        FilterSongs();
    }

    private async Task MoveUp(Song song)
    {
        int index = songs.IndexOf(song);

        if (index <= 0)
        {
            return;
        }

        PlaylistSongDB psDB = new PlaylistSongDB();
        await psDB.SwapSongPositionsAsync(id, songs[index].songID, songs[index - 1].songID);

        await LoadPlaylist();
    }

    private async Task MoveDown(Song song)
    {
        int index = songs.IndexOf(song);

        if (index >= songs.Count - 1)
        {
            return;
        }

        PlaylistSongDB psDB = new PlaylistSongDB();
        await psDB.SwapSongPositionsAsync(id, songs[index].songID, songs[index + 1].songID);

        await LoadPlaylist();
    }

    private async Task PlayAll()
    {
        if (songs.Count == 0)
        {
            return;
        }
    }

    private async Task Shuffle()
    {
        Random rnd = new Random();

        for (int i = songs.Count - 1; i > 0; i--)
        {
            int swapIndex = rnd.Next(i + 1);

            Song temp = songs[i];
            songs[i] = songs[swapIndex];
            songs[swapIndex] = temp;
        }

        PlaylistSongDB psDB = new PlaylistSongDB();

        for (int i = 0; i < songs.Count; i++)
        {
            await psDB.UpdateSongPositionAsync(id, songs[i].songID, i + 1);
        }
    }
}
