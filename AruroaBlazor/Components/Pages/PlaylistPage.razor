    @page "/playlist/{id:int}"

@using Models
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Services
@inject ProtectedSessionStorage Storage
@inject NavigationManager Nav

@if (user == null)
{
    <p>You must be logged in to view playlists.</p>
}
else
{
    if (playlist == null)
    {
        <p>Playlist not found.</p>
    }
    else
    {
        <h1>@playlist.name</h1>
        <p>@songs.Count songs</p>

        <button @onclick="PlayAll">Play All (NOT IMPLEMENTED YET)</button>
        <button @onclick="ToggleAddSongs">Add Songs</button>
        <button @onclick="Shuffle">Shuffle</button>

        @if (ShowAddSongs == true)
        {
            <select @bind="selectedSongId">
                <option value="0">-- Select song --</option>

                @foreach (Song s in filteredSongs)
                {
                    <option value="@s.songID">@s.title</option>
                }
            </select>

            <button @onclick="AddSongToPlaylist">Add</button>
        }

        @foreach (Song song in songs)
        {
            <div>
                <span>@song.title</span>
                <button @onclick="() => MoveUp(song)">Up</button>
                <button @onclick="() => MoveDown(song)">Down</button>
                <button @onclick="() => RemoveSong(song)">Remove</button>
            </div>
        }
    }
}

@code
{
    // Service instance
    private PlaylistPageService playlistService = new PlaylistPageService();

    // Route parameter
    [Parameter]
    public int id { get; set; }

    // UI state variables
    private User user;
    private Playlist playlist;
    private List<Song> songs = new List<Song>();
    private List<Song> allSongs = new List<Song>();
    private List<Song> filteredSongs = new List<Song>();
    private bool ShowAddSongs = false;
    private int selectedSongId = 0;

    // Lifecycle method - loads data on first render
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender == false)
        {
            return;
        }

        var storedUser = await Storage.GetAsync<User>("user");

        if (storedUser.Success == true)
        {
            user = storedUser.Value;
        }
        else
        {
            user = null;
        }

        if (user != null)
        {
            await LoadPlaylist();
            await LoadAllSongs();
            StateHasChanged();
        }
    }

    // Load playlist using service
    private async Task LoadPlaylist()
    {
        playlist = await playlistService.LoadPlaylistByIdAsync(id);

        if (playlist == null)
        {
            songs.Clear();
            return;
        }

        songs = await playlistService.LoadPlaylistSongsAsync(id);
    }

    // Load all songs using service
    private async Task LoadAllSongs()
    {
        allSongs = await playlistService.LoadAllSongsAsync();
        FilterSongs();
    }

    // Toggle add songs section
    private void ToggleAddSongs()
    {
        if (ShowAddSongs == true)
        {
            ShowAddSongs = false;
        }
        else
        {
            ShowAddSongs = true;
        }

        FilterSongs();
    }

    // Filter songs using service
    private void FilterSongs()
    {
        filteredSongs = playlistService.FilterAvailableSongs(allSongs, songs);
    }

    // Add song to playlist using service
    private async Task AddSongToPlaylist()
    {
        if (selectedSongId == 0)
        {
            return;
        }

        int maxPos = await playlistService.GetMaxPositionAsync(id);
        int newPosition = maxPos + 1;

        bool success = await playlistService.AddSongToPlaylistAsync(id, selectedSongId, newPosition);

        if (success)
        {
            selectedSongId = 0;
            ShowAddSongs = false;

            await LoadPlaylist();
            FilterSongs();
        }
    }

    // Remove song from playlist using service
    private async Task RemoveSong(Song song)
    {
        bool success = await playlistService.RemoveSongFromPlaylistAsync(id, song.songID);

        if (success)
        {
            await LoadPlaylist();
            FilterSongs();
        }
    }

    // Move song up in playlist using service
    private async Task MoveUp(Song song)
    {
        // Find the index of the song using a for loop
        int index = -1;
        for (int i = 0; i < songs.Count; i = i + 1)
        {
            if (songs[i].songID == song.songID)
            {
                index = i;
                break;
            }
        }

        if (index <= 0)
        {
            return;
        }

        bool success = await playlistService.SwapSongPositionsAsync(id, songs[index].songID, songs[index - 1].songID);

        if (success)
        {
            await LoadPlaylist();
        }
    }

    // Move song down in playlist using service
    private async Task MoveDown(Song song)
    {
        // Find the index of the song using a for loop
        int index = -1;
        for (int i = 0; i < songs.Count; i = i + 1)
        {
            if (songs[i].songID == song.songID)
            {
                index = i;
                break;
            }
        }

        if (index >= songs.Count - 1)
        {
            return;
        }

        bool success = await playlistService.SwapSongPositionsAsync(id, songs[index].songID, songs[index + 1].songID);

        if (success)
        {
            await LoadPlaylist();
        }
    }

    // Play all songs (not implemented yet)
    private async Task PlayAll()
    {
        if (songs.Count == 0)
        {
            return;
        }
    }

    // Shuffle playlist using service
    private async Task Shuffle()
    {
        // Shuffle songs using service
        songs = playlistService.ShuffleSongs(songs);

        // Update all positions using service
        bool success = await playlistService.UpdateAllSongPositionsAsync(id, songs);

        if (success)
        {
            StateHasChanged();
        }
    }
}